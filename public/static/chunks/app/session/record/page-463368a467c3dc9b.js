(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9323],{1493:e=>{e.exports={container:"ProgressBar_container__ZeYDS",filler:"ProgressBar_filler__TfPDP"}},2239:(e,s,t)=>{"use strict";t.d(s,{j:()=>c,k:()=>l});var r=t(3915),a=t(6203),n=t(5317);let o={apiKey:"AIzaSyB8XOlU5pDZV0FWvnRLk3520uYEgwbVmac",authDomain:"therascript-45b62.firebaseapp.com",projectId:"therascript-45b62",storageBucket:"therascript-45b62.appspot.com",messagingSenderId:"64757237031",appId:"1:64757237031:web:c541b0cf649c0d88fb5502"};console.log("\uD83D\uDD25 Firebase config being used:",o);let i=(0,r.Dk)().length?(0,r.Dk)()[0]:(0,r.Wp)(o),c=(0,a.getAuth)(i),l=(0,n.aU)(i)},2611:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>j});var r=t(5155),a=t(2115),n=t(5695),o=t(6874),i=t.n(o),c=t(9576),l=t(8315),u=t.n(l);function d(e){let{message:s,baseClass:t,successClass:a,errorClass:n}=e;if(!s)return null;let o=s.toLowerCase().includes("error")||s.toLowerCase().includes("failed"),i=t||u().container,c=o?n||u().error:a||u().success;return(0,r.jsx)("div",{className:"".concat(i," ").concat(c),role:"status",children:s})}var g=t(1493),p=t.n(g);function h(e){let{progress:s}=e;return s<=0?null:(0,r.jsx)("div",{className:p().container,children:(0,r.jsx)("div",{className:p().filler,style:{width:"".concat(s,"%")}})})}var _=t(8822),m=t.n(_);function S(e){let{variant:s="primary",className:t="",...a}=e,n="primary"===s?m().primary:m().secondary;return(0,r.jsx)("button",{className:"".concat(m().base," ").concat(n," ").concat(t),...a})}let f=()=>{let[e,s]=(0,a.useState)(!1),[t,r]=(0,a.useState)(0),[n,o]=(0,a.useState)(null),[i,c]=(0,a.useState)(""),[l,u]=(0,a.useState)(null),[d,g]=(0,a.useState)(null),p=(0,a.useRef)(null),h=(0,a.useRef)([]),_=(0,a.useRef)(null),m=(0,a.useRef)(null),S=(0,a.useCallback)(()=>{var e;null==(e=m.current)||e.getTracks().forEach(e=>e.stop()),m.current=null,_.current&&(clearInterval(_.current),_.current=null)},[]);(0,a.useEffect)(()=>()=>S(),[S]);let f=async()=>{if(!e){o(null),g(null),c("Requesting mic…");try{m.current=await navigator.mediaDevices.getUserMedia({audio:!0}),c("Recording…"),u(Date.now()),r(0);let e=new MediaRecorder(m.current);p.current=e,h.current=[],e.ondataavailable=e=>{e.data.size>0&&h.current.push(e.data)},e.onstop=()=>{let t=new Blob(h.current,{type:e.mimeType});o(t),s(!1),c("Stopped"),g(Date.now()),S()},e.start(),s(!0),_.current=setInterval(()=>{r(e=>e+1)},1e3)}catch(e){c("Mic error: "+(e.message||e.name)),S()}}};return{isRecording:e,recordingDuration:t,audioBlob:n,statusMessage:i,setStatusMessage:c,startTime:l,endTime:d,startRecording:f,stopRecording:()=>{var e;(null==(e=p.current)?void 0:e.state)==="recording"&&p.current.stop()}}};var v=t(2239),P=t(5317);async function y(e,s,t,r,a,n){let o={therapistId:e,createdAt:(0,P.O5)(),sessionDate:P.Dc.fromDate(r),transcript:s,soapNote:t,structuredContent:"",originalAudioFileName:a,status:"complete",sessionId:n};console.log("▶️ About to write therapySessionNote:",{therapistId:o.therapistId,transcript:o.transcript,sessionDate:o.sessionDate,createdAt:o.createdAt,originalAudioFileName:o.originalAudioFileName,status:o.status,sessionId:o.sessionId});try{let e=(0,P.H9)((0,P.rJ)(v.k,"therapySessionNotes"));return await (0,P.BN)(e,o),console.log("✅ Therapy session note saved with ID:",e.id),e.id}catch(e){throw console.error("❌ Error saving therapy session note to Firestore:",e),Error("Failed to save therapy note. Please try again.")}}let w=()=>{let[e,s]=(0,a.useState)(!1),[t,r]=(0,a.useState)(0),[n,o]=(0,a.useState)("");return{isProcessing:e,uploadProgress:t,statusMessage:n,processAudio:async(e,t,a,n)=>{if(!e){let e="Processing failed: audioBlob is missing.";console.error(e),o(e),null==n||n(!1,void 0,null,e);return}if(!a){let e="Processing failed: sessionId is missing or invalid.";console.error(e),o(e),null==n||n(!1,void 0,null,e);return}s(!0),r(0),o("Sending audio to transcriber…");try{var i;let s="session-audio.mp3",c=new File([e],s,{type:e.type});console.log("\uD83D\uDCE4 Uploading to Whisper with file.name:",c.name),r(10);let l=new FormData;l.append("file",c);let u="http://ec2-18-219-113-46.us-east-2.compute.amazonaws.com:8000";if(!u)throw Error("Whisper API URL is not defined in environment variables.");let d=await fetch("".concat(u,"/transcribe"),{method:"POST",body:l});if(!d.ok){let e=await d.text();throw Error("Transcription error: ".concat(d.status," - ").concat(e))}let g=(await d.json()).text;console.log("✅ Whisper transcript:",g),o("Transcript received. Sending to OpenAI…"),r(40);let p=await fetch("/api/generate-soap-note",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:g})});if(!p.ok){let e=await p.text();throw Error("SOAP note generation error: ".concat(p.status," - ").concat(e))}let h=(await p.json()).soapNote;console.log("✅ Received SOAP note:",h),o("Saving transcript and SOAP note…"),r(70);let _=null!=(i=c.name)?i:s;console.log("▶️ Final originalAudioFileName to write:",_);let m=await y(t,g,h,new Date,_,a);console.log("✅ Therapy session note saved with ID:",m),o("Saved successfully."),r(100),null==n||n(!0,{transcript:g,soapNote:h},m)}catch(s){let e="Processing failed: ".concat(s.message);console.error(e),o(e),null==n||n(!1,void 0,null,e)}finally{s(!1),r(100)}},setStatusMessage:o}};var b=t(7926),R=t.n(b);function x(e){let s=Math.floor(e/60),t=Math.floor(e%60);return"".concat(s,":").concat(String(t).padStart(2,"0"))}function j(){return(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading..."}),children:(0,r.jsx)(N,{})})}function N(){let e=(0,n.useRouter)(),s=(0,n.useSearchParams)(),[t]=(0,a.useState)(()=>{let e=s.get("sessionId");return e&&e.length>0?e:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let r=0;r<e;r++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}(24)}),{user:o,loading:l}=(0,c.A)(),[u,g]=(0,a.useState)(!1),[p,_]=(0,a.useState)(null),[m,v]=(0,a.useState)(null),[P,y]=(0,a.useState)(!1),{isRecording:b,recordingDuration:j,audioBlob:N,startRecording:D,stopRecording:k,statusMessage:A,setStatusMessage:I}=f(),{isProcessing:B,uploadProgress:E,processAudio:T,statusMessage:C}=w();return((0,a.useEffect)(()=>{l||o||e.push("/login")},[o,l,e]),(0,a.useEffect)(()=>{!b&&N&&o&&!P&&(y(!0),o.getIdToken().then(s=>{T(N,o.uid,t,async(s,t,r,a)=>{s&&t&&r?(console.log("✅ Saved therapySessionNote ID:",r),e.push("/dashboard")):(console.error("❌ Audio processing or save failed:",a),I("Audio processing failed. Please try again."))})}))},[b,N,o,P,T,e,t,I]),l)?(0,r.jsx)("div",{className:R().pageWrapper,children:(0,r.jsx)("div",{className:R().card,children:(0,r.jsx)("p",{children:"Loading authentication…"})})}):o?(0,r.jsx)("div",{className:R().pageWrapper,children:(0,r.jsxs)("div",{className:R().card,children:[(0,r.jsxs)("div",{className:R().headerRow,children:[(0,r.jsx)(i(),{href:"/dashboard",className:R().backLink,children:"← Dashboard"}),(0,r.jsx)("h1",{className:R().pageTitle,children:"Record New Session"})]}),(0,r.jsx)(d,{message:b?"Recording… (".concat(x(j),")"):C||A,baseClass:R().statusMessage,successClass:R().statusSuccess,errorClass:R().statusError}),!u&&(0,r.jsx)("p",{className:R().disclaimer,children:"By proceeding to record, you confirm you've obtained patient consent."}),(0,r.jsxs)("div",{className:R().controlsWrapper,children:[!b&&!u&&(0,r.jsx)(S,{variant:"primary",onClick:()=>{g(!0),_(new Date),y(!1),D()},children:"Start Recording"}),b&&(0,r.jsx)(S,{variant:"secondary",onClick:()=>{k(),v(new Date)},children:"Stop Recording"})]}),u&&m&&(0,r.jsxs)("div",{className:R().timeline,children:[null==p?void 0:p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"\xa0–\xa0",null==m?void 0:m.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"\xa0(Duration ",x(j),")"]}),B&&(0,r.jsx)(h,{progress:E})]})}):(0,r.jsx)("div",{className:R().pageWrapper,children:(0,r.jsx)("div",{className:R().card,children:(0,r.jsx)("p",{children:"Verifying session or redirecting..."})})})}},4828:(e,s,t)=>{Promise.resolve().then(t.bind(t,2611))},5695:(e,s,t)=>{"use strict";var r=t(8999);t.o(r,"notFound")&&t.d(s,{notFound:function(){return r.notFound}}),t.o(r,"useParams")&&t.d(s,{useParams:function(){return r.useParams}}),t.o(r,"usePathname")&&t.d(s,{usePathname:function(){return r.usePathname}}),t.o(r,"useRouter")&&t.d(s,{useRouter:function(){return r.useRouter}}),t.o(r,"useSearchParams")&&t.d(s,{useSearchParams:function(){return r.useSearchParams}})},7926:e=>{e.exports={pageWrapper:"RecordSessionPage_pageWrapper__JylSU",card:"RecordSessionPage_card__K0TSD",headerRow:"RecordSessionPage_headerRow__stdyF",pageTitle:"RecordSessionPage_pageTitle__BkjSz",backLink:"RecordSessionPage_backLink__a53w9",statusMessage:"RecordSessionPage_statusMessage__Y0Cha",statusSuccess:"RecordSessionPage_statusSuccess__39yDC",statusError:"RecordSessionPage_statusError__11427",disclaimer:"RecordSessionPage_disclaimer__Am4vg",fadeIn:"RecordSessionPage_fadeIn__TbAyn",controlsWrapper:"RecordSessionPage_controlsWrapper__x9nv_",hidden:"RecordSessionPage_hidden__4gk0a",base:"RecordSessionPage_base__NdRmD",recordingBadge:"RecordSessionPage_recordingBadge__MMdIY",pulse:"RecordSessionPage_pulse__bJtGQ",timeline:"RecordSessionPage_timeline__csz0X",progressBar:"RecordSessionPage_progressBar__IMsXD",progress:"RecordSessionPage_progress__HqSTP"}},8315:e=>{e.exports={container:"StatusBanner_container__VNHBU",success:"StatusBanner_success__6simE",error:"StatusBanner_error__axQ0U"}},8822:e=>{e.exports={base:"Button_base__GoPte",primary:"Button_primary__NvDjW",secondary:"Button_secondary__PNkAv"}},9576:(e,s,t)=>{"use strict";t.d(s,{A:()=>c,AuthProvider:()=>i});var r=t(5155),a=t(2115),n=t(2239);let o=(0,a.createContext)(void 0),i=e=>{let{children:s}=e,[t,i]=(0,a.useState)(null),[c,l]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=n.j.onAuthStateChanged(e=>{i(e),l(!1)});return()=>e()},[]);let u=async()=>{await n.j.signOut()};return(0,r.jsx)(o.Provider,{value:{user:t,loading:c,signOut:u},children:s})},c=()=>{let e=(0,a.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}},e=>{var s=s=>e(e.s=s);e.O(0,[4209,93,2992,6874,3915,9207,8441,1684,7358],()=>s(4828)),_N_E=e.O()}]);