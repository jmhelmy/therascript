(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8249],{9297:function(e,t,r){Promise.resolve().then(r.bind(r,8878))},8878:function(e,t,r){"use strict";let s;r.r(t),r.d(t,{default:function(){return RecordSessionPage}});var a=r(7437),n=r(2265),o=r(4033),c=r(1396),i=r.n(c);let useAudioRecorder=()=>{let[e,t]=(0,n.useState)(!1),[r,s]=(0,n.useState)(0),[a,o]=(0,n.useState)(null),[c,i]=(0,n.useState)(""),[u,l]=(0,n.useState)(null),[d,p]=(0,n.useState)(null),_=(0,n.useRef)(null),g=(0,n.useRef)([]),f=(0,n.useRef)(null),m=(0,n.useRef)(null),h=(0,n.useCallback)(()=>{var e;null===(e=m.current)||void 0===e||e.getTracks().forEach(e=>e.stop()),m.current=null,f.current&&(clearInterval(f.current),f.current=null)},[]);(0,n.useEffect)(()=>()=>h(),[h]);let startRecording=async()=>{if(!e){o(null),p(null),i("Requesting mic…");try{m.current=await navigator.mediaDevices.getUserMedia({audio:!0}),i("Recording…"),l(Date.now()),s(0);let e=new MediaRecorder(m.current);_.current=e,g.current=[],e.ondataavailable=e=>{e.data.size>0&&g.current.push(e.data)},e.onstop=()=>{let r=new Blob(g.current,{type:e.mimeType});o(r),t(!1),i("Stopped"),p(Date.now()),h()},e.start(),t(!0),f.current=setInterval(()=>{s(e=>e+1)},1e3)}catch(e){i("Mic error: "+(e.message||e.name)),h()}}};return{isRecording:e,recordingDuration:r,audioBlob:a,statusMessage:c,setStatusMessage:i,startTime:u,endTime:d,startRecording,stopRecording:()=>{var e;(null===(e=_.current)||void 0===e?void 0:e.state)==="recording"&&_.current.stop()}}},u="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var l={randomUUID:u};let d=new Uint8Array(16),p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));var esm_browser_v4=function(e,t,r){if(l.randomUUID&&!t&&!e)return l.randomUUID();e=e||{};let a=e.random??e.rng?.()??function(){if(!s){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");s=crypto.getRandomValues.bind(crypto)}return s(d)}();if(a.length<16)throw Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}(a)};let useAudioProcessor=()=>{let[e,t]=(0,n.useState)(!1),[s,a]=(0,n.useState)(0),[o,c]=(0,n.useState)(""),processAudio=async(e,s,n)=>{if(!e||!s){let e="Audio data or therapist ID missing.";c(e),null==n||n(!1,e);return}t(!0),a(0),c("Preparing to upload audio...");try{var o;let{getStorage:i,ref:u,uploadBytesResumable:l}=await Promise.all([r.e(3991),r.e(4308),r.e(2320)]).then(r.bind(r,2320)),{auth:d}=await Promise.all([r.e(5315),r.e(4358),r.e(3991),r.e(8105),r.e(4308),r.e(9640),r.e(2625)]).then(r.bind(r,2625)),p=d.currentUser;if(!p)throw Error("User not authenticated. Cannot process note.");let _=esm_browser_v4(),g=(null===(o=e.type.split("/")[1])||void 0===o?void 0:o.split(";")[0])||"bin",f="sessions/".concat(s,"/").concat(_,".").concat(g),m=i(),h=u(m,f),S={contentType:e.type||"audio/webm"},y=l(h,e,S);y.on("state_changed",e=>{let t=e.bytesTransferred/e.totalBytes*100;a(t),c("Uploading audio: ".concat(Math.round(t),"%"))},e=>{let r="Audio upload failed: ".concat(e.code||e.message,".");c(r),t(!1),a(0),null==n||n(!1,r)},async()=>{let e,r;c("Upload complete! Generating session note...");try{e=await p.getIdToken()}catch(r){let e="Could not get user token.";c(e),t(!1),null==n||n(!1,e);return}let s=Date.now(),a="http://127.0.0.1:5001/".concat("therascript-45b62","/").concat("us-central1","/").concat("generateNote"),o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({audioFileName:f,sessionDate:s})}),i=await o.text();try{r=JSON.parse(i)}catch(r){let e="Invalid server response (HTTP ".concat(o.status,")");c(e),t(!1),null==n||n(!1,e);return}if(o.ok&&r.success){let e=r.message||"Note generated! ID: ".concat(r.noteId);c(e),null==n||n(!0,e,r.noteId)}else{let e=r.error||r.message||"Failed to process note";c(e),null==n||n(!1,e)}})}catch(e){c("Processing failed: ".concat(e.message)),null==n||n(!1,"Processing failed: ".concat(e.message))}finally{t(!1)}};return{isProcessing:e,uploadProgress:s,statusMessage:o,processAudio}};var _=r(1486),g=r.n(_);function StatusBanner(e){let{message:t,baseClass:r,successClass:s,errorClass:n}=e;if(!t)return null;let o=t.toLowerCase().includes("error")||t.toLowerCase().includes("failed"),c=r||g().container,i=o?n||g().error:s||g().success;return(0,a.jsx)("div",{className:"".concat(c," ").concat(i),role:"status",children:t})}var f=r(2793),m=r.n(f);function ProgressBar(e){let{progress:t}=e;return t<=0?null:(0,a.jsx)("div",{className:m().container,children:(0,a.jsx)("div",{className:m().filler,style:{width:"".concat(t,"%")}})})}var h=r(8028),S=r.n(h);function Button(e){let{variant:t="primary",className:r="",...s}=e,n="primary"===t?S().primary:S().secondary;return(0,a.jsx)("button",{className:"".concat(S().base," ").concat(n," ").concat(r),...s})}var y=r(677),v=r.n(y);function RecordSessionPage(){let e=(0,o.useRouter)(),[t,s]=(0,n.useState)(null),[c,u]=(0,n.useState)(!0);(0,n.useEffect)(()=>{let t;let setupAuth=async()=>{let{getAuth:a,onAuthStateChanged:n}=await Promise.all([r.e(5315),r.e(3991),r.e(3642)]).then(r.bind(r,8153)),o=a();t=n(o,t=>{t?s(t):e.push("/login"),u(!1)})};return setupAuth(),()=>{t&&t()}},[e]);let{isRecording:l,recordingDuration:d,audioBlob:p,startRecording:_,stopRecording:g,statusMessage:f,setStatusMessage:m}=useAudioRecorder(),{isProcessing:h,uploadProgress:S,processAudio:y,statusMessage:R}=useAudioProcessor(),b=l?"Recording… (".concat("".concat(Math.floor(d/60),":").concat(String(Math.floor(d%60)).padStart(2,"0")),")"):R||f,[P,w]=(0,n.useState)(!1),[x,N]=(0,n.useState)(null),[j,B]=(0,n.useState)(null),[k,D]=(0,n.useState)(!1);return((0,n.useEffect)(()=>{!l&&p&&t&&!k&&(D(!0),y(p,t.uid,(t,r,s)=>{t&&setTimeout(()=>e.push(s?"/notes/".concat(s):"/dashboard"),1500)}))},[l,p,t,k,y,e]),c)?(0,a.jsx)("div",{className:v().pageWrapper,children:(0,a.jsx)("div",{className:v().card,children:(0,a.jsx)("p",{children:"Loading authentication…"})})}):t?(0,a.jsx)("div",{className:v().pageWrapper,children:(0,a.jsxs)("div",{className:v().card,children:[(0,a.jsxs)("div",{className:v().headerRow,children:[(0,a.jsx)(i(),{href:"/dashboard",className:v().backLink,children:"← Dashboard"}),(0,a.jsx)("h1",{className:v().pageTitle,children:"Record New Session"})]}),(0,a.jsx)(StatusBanner,{message:b,baseClass:v().statusMessage,successClass:v().statusSuccess,errorClass:v().statusError}),!P&&(0,a.jsx)("p",{className:v().disclaimer,children:"By proceeding to record, you confirm you’ve obtained patient consent."}),(0,a.jsxs)("div",{className:v().controlsWrapper,children:[!l&&!P&&(0,a.jsx)(Button,{variant:"primary",onClick:()=>{w(!0),N(new Date),D(!1),_()},children:"Start Recording"}),l&&(0,a.jsx)(Button,{variant:"secondary",onClick:()=>{g(),B(new Date)},children:"Stop Recording"})]}),P&&j&&(0,a.jsxs)("div",{className:v().timeline,children:[null==x?void 0:x.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"\xa0–\xa0",j.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"\xa0(Duration ",d,")"]}),h&&(0,a.jsx)(ProgressBar,{progress:S})]})}):(0,a.jsx)("div",{className:v().pageWrapper,children:(0,a.jsx)("div",{className:v().card,children:(0,a.jsx)("p",{children:"User not authenticated. Redirecting…"})})})}},677:function(e){e.exports={pageWrapper:"RecordSessionPage_pageWrapper__JylSU",card:"RecordSessionPage_card__K0TSD",headerRow:"RecordSessionPage_headerRow__stdyF",pageTitle:"RecordSessionPage_pageTitle__BkjSz",backLink:"RecordSessionPage_backLink__a53w9",statusMessage:"RecordSessionPage_statusMessage__Y0Cha",statusSuccess:"RecordSessionPage_statusSuccess__39yDC",statusError:"RecordSessionPage_statusError__11427",disclaimer:"RecordSessionPage_disclaimer__Am4vg",fadeIn:"RecordSessionPage_fadeIn__TbAyn",controlsWrapper:"RecordSessionPage_controlsWrapper__x9nv_",hidden:"RecordSessionPage_hidden__4gk0a",base:"RecordSessionPage_base__NdRmD",recordingBadge:"RecordSessionPage_recordingBadge__MMdIY",pulse:"RecordSessionPage_pulse__bJtGQ",timeline:"RecordSessionPage_timeline__csz0X",progressBar:"RecordSessionPage_progressBar__IMsXD",progress:"RecordSessionPage_progress__HqSTP"}},8028:function(e){e.exports={base:"Button_base__GoPte",primary:"Button_primary__NvDjW",secondary:"Button_secondary__PNkAv"}},2793:function(e){e.exports={container:"ProgressBar_container__zZSnW",filler:"ProgressBar_filler__48HmV"}},1486:function(e){e.exports={container:"StatusBanner_container__EtWLx",success:"StatusBanner_success__mOJQ6",error:"StatusBanner_error__JQLnU"}},622:function(e,t,r){"use strict";/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var s=r(2265),a=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function q(e,t,r){var s,n={},u=null,l=null;for(s in void 0!==r&&(u=""+r),void 0!==t.key&&(u=""+t.key),void 0!==t.ref&&(l=t.ref),t)o.call(t,s)&&!i.hasOwnProperty(s)&&(n[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===n[s]&&(n[s]=t[s]);return{$$typeof:a,type:e,key:u,ref:l,props:n,_owner:c.current}}t.Fragment=n,t.jsx=q,t.jsxs=q},7437:function(e,t,r){"use strict";e.exports=r(622)},1396:function(e,t,r){e.exports=r(8326)},4033:function(e,t,r){e.exports=r(94)}},function(e){e.O(0,[8326,2971,2472,1744],function(){return e(e.s=9297)}),_N_E=e.O()}]);